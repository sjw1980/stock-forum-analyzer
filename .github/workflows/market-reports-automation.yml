name: Market Reports Automation

on:
  schedule:
    - cron: '30 23 * * 0-4' # UTC 23ì‹œ 30ë¶„ = KST 8ì‹œ 30ë¶„ (ì¼-ëª©, ë‹¤ìŒë‚  ì›”-ê¸ˆ) - Pre-market
    - cron: '0 9 * * 1-5'   # UTC 9ì‹œ = KST 18ì‹œ (ì›”-ê¸ˆ) - Post-market
    - cron: '0 13 * * 0'    # UTC 13ì‹œ ì¼ìš”ì¼ = KST ì¼ìš”ì¼ 22ì‹œ - Weekly
    - cron: '0 0 1 * *'     # UTC 0ì‹œ ë§¤ì›” 1ì¼ = KST ë§¤ì›” 1ì¼ 9ì‹œ - Monthly
  workflow_dispatch:
    inputs:
      report_type:
        description: 'Report type to generate'
        required: true
        default: 'pre_market'
        type: choice
        options:
        - pre_market
        - post_market
        - weekly
        - monthly

  push:
    paths:
      - "**.py"
      - "doc/requirements.txt"
      - ".github/workflows/**"

jobs:
  determine_report_type:
    runs-on: ubuntu-latest
    outputs:
      report_type: ${{ steps.determine.outputs.report_type }}
    steps:
      - name: Determine report type based on schedule
        id: determine
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "report_type=${{ github.event.inputs.report_type }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "push" ]; then
            echo "report_type=all" >> $GITHUB_OUTPUT
          else
            # ìŠ¤ì¼€ì¤„ì— ë”°ë¼ ë³´ê³ ì„œ íƒ€ìž… ê²°ì •
            hour=$(date -u +%H)
            minute=$(date -u +%M)
            day_of_week=$(date -u +%u)  # 1=ì›”ìš”ì¼, 7=ì¼ìš”ì¼
            day_of_month=$(date -u +%d)
            
            if [ "$hour" = "23" ] && [ "$minute" = "30" ]; then
              echo "report_type=pre_market" >> $GITHUB_OUTPUT
            elif [ "$hour" = "09" ] && [ "$minute" = "00" ] && [ "$day_of_week" -le "5" ]; then
              echo "report_type=post_market" >> $GITHUB_OUTPUT
            elif [ "$hour" = "13" ] && [ "$minute" = "00" ] && [ "$day_of_week" = "7" ]; then
              echo "report_type=weekly" >> $GITHUB_OUTPUT
            elif [ "$hour" = "00" ] && [ "$minute" = "00" ] && [ "$day_of_month" = "01" ]; then
              echo "report_type=monthly" >> $GITHUB_OUTPUT
            else
              echo "report_type=pre_market" >> $GITHUB_OUTPUT  # ê¸°ë³¸ê°’
            fi
          fi

  generate_reports:
    needs: determine_report_type
    runs-on: ubuntu-latest
    environment:
      name: production
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r doc/requirements.txt 

      - name: Create .env file for GitHub Actions
        run: |
          cat > .env << EOF
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_CHARSET=utf8mb4
          CRAWLING_DELAY=1.0
          MAX_PAGES=${{ github.event.inputs.max_pages || '10' }}
          USER_AGENT=Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36
          LOG_LEVEL=INFO
          LOG_FILE=crawler.log
          EOF

      - name: Verify configuration
        run: |
          python source/config.py

      - name: Test database connection
        run: |
          python -c "
          import sys; sys.path.insert(0, 'source')
          from database import test_database_connection
          if test_database_connection():
              print('âœ… Database connection successful')
          else:
              print('âŒ Database connection failed')
              exit(1)
          "

      - name: Generate market report
        env:
          DB_PORT: ${{ secrets.DB_PORT || 3306 }}
          REPORT_TYPE: ${{ needs.determine_report_type.outputs.report_type }}
        run: |
          if [ "$REPORT_TYPE" = "all" ]; then
            echo "ðŸ§ª Testing all reports..."
            
            echo "ðŸŒ… Generating pre-market report..."
            python source/pattern_analyzer.py pre_market $(date -d '+9 hours' '+%Y%m%d')
            
            echo "ðŸŒ† Generating post-market report..."
            python source/pattern_analyzer.py post_market $(date -d '+9 hours' '+%Y%m%d')
            
            echo "ðŸ“Š Generating weekly report..."
            python source/pattern_analyzer.py weekly $(date -d '+9 hours' '+%Y%m%d')
            
            echo "ðŸ“ˆ Generating monthly report..."
            python source/pattern_analyzer.py monthly $(date -d '+9 hours' '+%Y%m%d')
            
            echo "âœ… All reports generated successfully!"
          else
            case $REPORT_TYPE in
              "pre_market")
                echo "ðŸŒ… Generating pre-market report..."
                python source/pattern_analyzer.py pre_market $(date -d '+9 hours' '+%Y%m%d')
                ;;
              "post_market")
                echo "ðŸŒ† Generating post-market report..."
                python source/pattern_analyzer.py post_market $(date -d '+9 hours' '+%Y%m%d')
                ;;
              "weekly")
                echo "ðŸ“Š Generating weekly report..."
                python source/pattern_analyzer.py weekly $(date -d '+9 hours' '+%Y%m%d')
                ;;
              "monthly")
                echo "ðŸ“ˆ Generating monthly report..."
                python source/pattern_analyzer.py monthly $(date -d '+9 hours' '+%Y%m%d')
                ;;
              *)
                echo "âŒ Unknown report type: $REPORT_TYPE"
                exit 1
                ;;
            esac
          fi
      
      - name: Commit and push changes
        env:
          REPORT_TYPE: ${{ needs.determine_report_type.outputs.report_type }}
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          
          if [ "$REPORT_TYPE" = "all" ]; then
            commit_message="í…ŒìŠ¤íŠ¸: ëª¨ë“  ë³´ê³ ì„œ ìƒì„± ë° README.md ì—…ë°ì´íŠ¸"
          else
            case $REPORT_TYPE in
              "pre_market")
                commit_message="ìžë™ ìž¥ì „ ë³´ê³ ì„œ ë° README.md ì—…ë°ì´íŠ¸"
                ;;
              "post_market")
                commit_message="ìžë™ ìž¥ë§ˆê° ë³´ê³ ì„œ ë° README.md ì—…ë°ì´íŠ¸"
                ;;
              "weekly")
                commit_message="ìžë™ ì£¼ê°„ ë³´ê³ ì„œ ë° README.md ì—…ë°ì´íŠ¸"
                ;;
              "monthly")
                commit_message="ìžë™ ì›”ê°„ ë³´ê³ ì„œ ë° README.md ì—…ë°ì´íŠ¸"
                ;;
            esac
          fi
          
          git diff --cached --quiet || git commit -m "$commit_message"
          branch_name=$(echo "${GITHUB_REF#refs/heads/}")
          git push origin HEAD:$branch_name
